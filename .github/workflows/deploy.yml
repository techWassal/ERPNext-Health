name: Deploy ERPNext

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Define the deployment directory from secret or default
            DEPLOY_DIR="${{ secrets.DEPLOY_PATH }}"
            if [ -z "$DEPLOY_DIR" ]; then
              DEPLOY_DIR="/opt/erpnext"
            fi
            
            echo "üöÄ Connecting to VPS..."
            
            if [ -d "$DEPLOY_DIR" ]; then
                cd "$DEPLOY_DIR"
                
                # Update configurations from git
                echo "üì• Pulling latest configuration..."
                git pull origin main
                
                # Run the update script which rebuilds the image (on the server) and updates services
                # We use date-based versioning for clarity
                echo "üîÑ Starting update process..."
                ./update_erpnext.sh --rebuild v15-$(date +%Y%m%d)
            else
                echo "‚ùå Deployment directory $DEPLOY_DIR not found!"
                exit 1
            fi
